---
title: "Assessing the Robustness of Neural System Segregation across Modality, Task & Time"
author: Ethan Knights & Rik Henson
date: "`r Sys.Date()`"
output: html_document
---

# Notebook: Orthogonal Normalisation
**Test for effects (Age/Cognition) on SyS that is calculated using 3 different normalisation approaches. **

$$ Classic Normalisation = [W - B / W] $$
$$ OrthogonalNormalisation = [W - B / W + B] $$
$$ OmitNormalisation = [ W - B ] $$
See the following respective reports:<br>

+ runAnalysis_WithGlobalSignal.Rmd
+ runAnalysis_Normalisation-OrthongalNorm.Rmd
+ runAnalysis_Normalisation-NoNorm.Rmd

This report uses SyS column with an empty norm SyS prefix (representing orthogonal normalisation) i.e., rather than 'chanNorm' or 'noNorm'

## Setup
```{r}
wd = '/imaging/camcan/sandbox/ek03/projects/functional-segregation_fMRI-MEG/R'; setwd(wd)
library(tidyr)
library(knitr)
library(broom)
library(ggplot2)
```

Ensure SyS data (.csv) are in the raw directory specified below.<br>
  Output images will be stored in the output directory specified below. <br>
  ```{r}
rawDir = 'csv'
outImageDir = 'images'; dir.create(outImageDir,showWarnings = FALSE)
```
Read dataset.
```{r}
df = read.csv(file.path(rawDir,'SyS-WithGlobalSignal.csv')); #head(df)
```
Add Age quadratic term.
```{r}
df$ageQuad <- poly(df$age,2) #1st linear, 2nd quad
```
Remove subjects with any missing measure (SyS + Cognition) to simplify age-residualisation later.
```{r}
df = df[complete.cases(df$Cattell_700), ]
df = df[complete.cases(df$Memory_700), ]
df = df[complete.cases(df$fMRI_craddock_corr_metric_SyS), ]
sprintf('Remaining Subjects = %1.0f',nrow(df))
```
Create age-residualised SyS + Cognition variables for better plotting.
```{r}
lm_model <- lm(Cattell_700 ~ age, data = df)
df$Cattell_700_ageResid = residuals(lm_model)

lm_model <- lm(Memory_700 ~ age, data = df)
df$Memory_700_ageResid = residuals(lm_model)

#700
lm_model <- lm(fMRI_craddock_corr_metric_SyS ~ age, data = df)
df$fMRI_craddock_corr_metric_SyS_ageResid = residuals(lm_model)
```
<br>

## 1) Effect of Age
```{r}
lm_model <- lm(scale(fMRI_craddock_corr_metric_SyS) ~ scale(ageQuad),
               data = df); summary(lm_model) %>% 
  tidy() %>%  kable(caption = "Table 1. Effect of Age (OrthogonalNorm).",col.names = c("Predictor", "B", "SE", "t", "p"),  digits = c(0, 2, 3, 2, 3))
```
<br>

```{r}
p <- ggplot(df, aes(x = age, y = fMRI_craddock_corr_metric_SyS))
p <- p + geom_point(shape = 21, size = 3, colour = "black", fill = "white", stroke = 2)
#p <- p + stat_smooth(method = "lm", se = TRUE, fill = "grey60", formula = y ~ x, colour = "springgreen3", size = 3)
p <- p + stat_smooth(method = "lm", se = TRUE, fill = "grey60", formula = y ~ poly(x,2, raw = TRUE), colour = "springgreen3", size = 3)
#formatting
p <- p + scale_x_continuous(breaks = round(seq(20, max(80), by = 20),1),limits = c(15,90)) + #ylim(0,400) +
  theme_bw() + theme(panel.border = element_blank(), legend.position = "none",text = element_text(size=14),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black",size = 1.5),axis.ticks = element_line(colour = "black", size = 1.5))
ggsave(file.path(outImageDir,'Age_fMRI_orthogonalNorm.png'), width = 25, height = 25, units = 'cm', dpi = 300); p
```
<br>


  
## 2A) Effect on Cognition: Cattell
  
```{r}
lm_model <- lm(Cattell_700 ~scale(fMRI_craddock_corr_metric_SyS) * scale(ageQuad),
               data = df); summary(lm_model) %>% 
  tidy() %>%  kable(caption = "Table 2. Effect on Cattell (OrthogonalNorm).",col.names = c("Predictor", "B", "SE", "t", "p"),  digits = c(0, 2, 3, 2, 3))
```

```{r}
p <- ggplot(df, aes(y = scale(Cattell_700_ageResid), x = fMRI_craddock_corr_metric_SyS_ageResid))
p <- p + geom_point(shape = 21, size = 3, colour = "black", fill = "white", stroke = 2)
p <- p + stat_smooth(method = "lm", se = TRUE, fill = "grey60", formula = y ~ x, colour = "springgreen3", size = 3)
#formatting
p <- p + #xlim() + #ylim(0,400) +
  theme_bw() + theme(panel.border = element_blank(), legend.position = "none",text = element_text(size=14),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black",size = 1.5),axis.ticks = element_line(colour = "black", size = 1.5))
ggsave(file.path(outImageDir,"Cog-Cattell_fMRI_OrthogonalNorm.png"), width = 25, height = 25, units = 'cm', dpi = 300); p
```
<br>

## 2B) Effect on Cognition: Memory
  
```{r}
lm_model <- lm(Memory_700 ~scale(fMRI_craddock_corr_metric_SyS) * scale(ageQuad),
               data = df); summary(lm_model) %>% 
  tidy() %>%  kable(caption = "Table 3. Effect on Memory (OrthogonalNorm).",col.names = c("Predictor", "B", "SE", "t", "p"),  digits = c(0, 2, 3, 2, 3))
```

<br>
```{r}
p <- ggplot(df, aes(y = scale(Memory_700_ageResid), x = fMRI_craddock_corr_metric_SyS_ageResid))
p <- p + geom_point(shape = 21, size = 3, colour = "black", fill = "white", stroke = 2)
p <- p + stat_smooth(method = "lm", se = TRUE, fill = "grey60", formula = y ~ x, colour = "springgreen3", size = 3)
#formatting
p <- p + #xlim() + #ylim(0,400) +
  theme_bw() + theme(panel.border = element_blank(), legend.position = "none",text = element_text(size=14),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black",size = 1.5),axis.ticks = element_line(colour = "black", size = 1.5))
ggsave(file.path(outImageDir,"Cog-Memory_fMRI_OrthogonalNorm.png"), width = 25, height = 25, units = 'cm', dpi = 300); p
```
<br>

## 3) Intraclass correlation between Normalisation Approaches

```{r} 
library(irr)
tmpDF = cbind(df$fMRI_craddock_corr_metric_SyS_chanNorm,df$fMRI_craddock_corr_metric_SyS)
icc(tmpDF)
```

```{r}
p <- ggplot(df, aes(x = fMRI_craddock_corr_metric_SyS_chanNorm, y = fMRI_craddock_corr_metric_SyS, colour = age))
p <- p + geom_point(shape = 21, size = 3, stroke = 2, alpha = 0.4) + 
  geom_abline(intercept = 0, slope = 1, linetype = 'dashed')
#formatting
p <- p + xlim(0.3,1.25) + ylim(0.3,1.25) +
  scale_color_gradient(low="green", high="red") +
  theme_bw() + theme(panel.border = element_blank(), legend.position = "none",text = element_text(size=14),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black",size = 1.5),axis.ticks = element_line(colour = "black", size = 1.5))
ggsave(file.path(outImageDir,"ICC_Norm-ClassicVSOrthog.png"), width = 25, height = 25, units = 'cm', dpi = 300); p
```
<br>

